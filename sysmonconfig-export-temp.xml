<!--
  A Sysmon configuration file
  Author: 		Jakawal Ongthongkum
  Version:		1.0
  Date: 		2021-08-10
  References:	https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon
  				https://github.com/SwiftOnSecurity/sysmon-config
				https://github.com/olafhartong/sysmon-modular
-->

<Sysmon schemaversion="4.50">
	<!-- SYSMON META CONFIG -->
	<HashAlgorithms>md5,sha256</HashAlgorithms>
	<!-- Both MD5 and SHA256 are the industry-standard algorithms -->
	<CheckRevocation>False</CheckRevocation> 
	<!-- Check loaded drivers, log if their code-signing certificate has been revoked, in case malware stole one to sign a kernel driver -->
	<!-- Setting this to true might impact performance -->
	<DnsLookup>False</DnsLookup>
  	<!-- Disables lookup behavior, default is True (Boolean) -->
	<ArchiveDirectory>Sysmon</ArchiveDirectory>
	<!-- Name of directories at volume roots into which copy-on-delete files are moved. The directory is protected with a System ACL --> 
	<!-- You can use PsExec from Sysinternals to access the directory using psexec -sid cmd). Default: Sysmon -->

	<EventFiltering>

	<!--SYSMON EVENT ID 7 : DLL (IMAGE) LOADED BY PROCESS [ImageLoad]-->
	<!--DATA: UtcTime, ProcessGuid, ProcessId, Image, ImageLoaded, Hashes, Signed, Signature, SignatureStatus-->
	<!--Caution: Can cause high system load, disabled by default.-->
	<RuleGroup groupRelation="or">
		<ImageLoad onmatch="include">
			<Rule groupRelation="and">
				<OriginalFileName name="T1059.001,PowerShell" condition="is">amsi.dll</OriginalFileName>
				<Image condition="excludes any">powershell.exe;powershell_ise.exe</Image>
			</Rule>
			<Rule groupRelation="and">
				<Image name="T0137.005,Startup_Items" condition="end with">bginfo.exe</Image>
				<ImageLoaded condition="contains any">System.ni.dll;System.Core.ni.dll</ImageLoaded>
			</Rule>
			<ImageLoaded name="T1197,BITS" condition="end with">bitsproxy.dll</ImageLoaded>
			<Rule groupRelation="and">
				<OriginalFileName name="T1055,Process_Injection" condition="is">clr.dll</OriginalFileName>
				<Image condition="excludes">C:\Windows\Microsoft.NET\</Image>
			</Rule>
			<Rule groupRelation="and">
				<OriginalFileName name="T1055,Process_Injection" condition="is">clrjit.dll</OriginalFileName>
				<Image condition="excludes">C:\Windows\Microsoft.NET\</Image>
			</Rule>
			<Rule groupRelation="and">
				<OriginalFileName name="T1055,Process_Injection" condition="is">mscoreei.dll</OriginalFileName>
				<Image condition="excludes">C:\Windows\Microsoft.NET\</Image>
			</Rule>
			<Rule groupRelation="and">
				<OriginalFileName name="T1055,Process_Injection" condition="is">mscoree.dll</OriginalFileName>
				<Image condition="excludes">C:\Windows\Microsoft.NET\</Image>
			</Rule>
			<Rule groupRelation="and">
				<OriginalFileName name="T1055,Process_Injection" condition="is">mscoreeis.dll</OriginalFileName>
				<Image condition="excludes">C:\Windows\Microsoft.NET\</Image>
			</Rule>
			<Rule groupRelation="and">
				<OriginalFileName name="T1055,Process_Injection" condition="is">mscorlib.dll</OriginalFileName>
				<Image condition="excludes">C:\Windows\Microsoft.NET\</Image>
			</Rule>
			<Rule groupRelation="and">
				<OriginalFileName name="T1055,Process_Injection" condition="is">mscorlib.ni.dll</OriginalFileName>
				<Image condition="excludes">C:\Windows\Microsoft.NET\</Image>
			</Rule>
			<ImageLoaded name="T1047,Windows_Scheduled_Tasks" condition="end with">mstask.dll</ImageLoaded>
			<ImageLoaded name="T1064,Windows_Scripting_Host_Component" condition="end with">wshom.ocx</ImageLoaded>
			<OriginalFileName condition="is">scrrun.dll</OriginalFileName>
			<OriginalFileName condition="is">vbscript.dll</OriginalFileName>
			<Rule groupRelation="and">
				<OriginalFileName name="T1170,MSHTA_with_AMSI_Bypass" condition="is">jscript.dll</OriginalFileName>
				<Image condition="end with">mshta.exe</Image>
			</Rule>
			<Rule groupRelation="and">
				<OriginalFileName name="T1170,MSHTA_with_AMSI_Bypass" condition="is">jscript9.dll</OriginalFileName>
				<Image condition="end with">mshta.exe</Image>
			</Rule>
			<ImageLoaded name="T1137,Office_Application_Startup" condition="end with">.wll</ImageLoaded>
			<ImageLoaded name="T1137,Office_Application_Startup" condition="end with">.xll</ImageLoaded>
			<Rule groupRelation="and">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName name="T1175,Component_Object_Model_and_Distributed_COM" condition="is">combase.dll</OriginalFileName>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName name="T1175,Component_Object_Model_and_Distributed_COM" condition="is">coml2.dll</OriginalFileName>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName name="T1175,Component_Object_Model_and_Distributed_COM" condition="is">comsvcs.dll</OriginalFileName>
			</Rule>
			<Rule groupRelation="and" name="T1055,Process_Injection">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<ImageLoaded condition="begin with">C:\Windows\assembly\</ImageLoaded>
			</Rule>
			<Rule groupRelation="and" name="T1055,Process_Injection">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<ImageLoaded condition="begin with">C:\Windows\Microsoft.NET\assembly\GAC_MSIL</ImageLoaded>
			</Rule>
			<Rule groupRelation="and" name="T1055,Process_Injection">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName condition="is">clr.dll</OriginalFileName>
			</Rule>
			<Rule groupRelation="and" name="T1059.005,Command_and_Scripting_Interpreter_VBScript">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName condition="is">VBE7INTL.DLL</OriginalFileName>
			</Rule>
			<Rule groupRelation="and" name="T1059.005,Command_and_Scripting_Interpreter_VBScript">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName condition="is">VBE7.DLL</OriginalFileName>
			</Rule>
			<Rule groupRelation="and" name="T1059.005,Command_and_Scripting_Interpreter_VBScript">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName condition="is">VBEUI.DLL</OriginalFileName>
			</Rule>
			<Rule groupRelation="and" name="T1137.001,Office_Template_Macros">
				<Image condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<OriginalFileName condition="is">OUTLVBA.DLL</OriginalFileName>
			</Rule>
			<Image name="T1137,Office_Application_Startup" condition="end with">VSTOInstaller.exe</Image>
			<Rule groupRelation="and">
				<Image name="T1047,Windows_Management_Instrumentation" condition="contains all">C:\Program Files;\Microsoft Office\root\Office</Image>
				<ImageLoaded condition="is">C:\Windows\SysWOW64\wbem\wbemdisp.dll</ImageLoaded>
			</Rule>
			<ImageLoaded name="T1059.001,PowerShell" condition="end with">system.management.automation.ni.dll</ImageLoaded>
			<ImageLoaded name="T1059.001,PowerShell" condition="end with">system.management.automation.dll</ImageLoaded>
			<ImageLoaded name="T1059.001,PowerShell" condition="end with">Microsoft.PowerShell.Commands.Diagnostics.dll</ImageLoaded>
			<ImageLoaded name="T1059.001,PowerShell" condition="end with">Microsoft.PowerShell.Commands.Management.dll</ImageLoaded>
			<ImageLoaded name="T1059.001,PowerShell" condition="end with">Microsoft.PowerShell.Commands.Utility.dll</ImageLoaded>
			<ImageLoaded name="T1059.001,PowerShell" condition="end with">Microsoft.PowerShell.ConsoleHost.dll</ImageLoaded>
			<ImageLoaded name="T1059.001,PowerShell" condition="end with">Microsoft.PowerShell.Security.dll</ImageLoaded>
			<ImageLoaded name="1210,Exploitation_of_Remote_Services" condition="begin with">C:\Windows\System32\spool\drivers\</ImageLoaded>
			<OriginalFileName name="T1112,Modify_Registry" condition="is">regsvc.dll</OriginalFileName>
			<Rule groupRelation="and">
				<Image condition="end with">rundll32.exe</Image>
				<OriginalFileName name="T1003.004,LSASS_Memory" condition="is">comsvcs.dll</OriginalFileName>
			</Rule>
			<OriginalFileName name="T1053,Scheduled_Task" condition="is">taskschd.dll</OriginalFileName>
			<ImageLoaded name="T1218.010,Regsvr32" condition="end with">scrobj.dll</ImageLoaded>
			<OriginalFileName name="T1218.010,Regsvr32" condition="is">scrobj.dll</OriginalFileName>
			<ImageLoaded name="T1073,DLL_Side-Loading" condition="contains any">admin$;c$;\\;\appdata\;\temp\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">c:\programdata\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\Media\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\addins\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\system32\config\systemprofile\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\Debug\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\Temp</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\PerfLogs\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\Help\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Intel\Logs\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Temp</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\repair\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\security\</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">C:\Windows\Fonts\</ImageLoaded>
			<ImageLoaded condition="contains" name="T1073,DLL_Side-Loading">Downloads</ImageLoaded>
			<ImageLoaded condition="contains" name="T1073,DLL_Side-Loading">Public</ImageLoaded>
			<ImageLoaded condition="contains" name="T1073,DLL_Side-Loading">Documents</ImageLoaded>
			<ImageLoaded condition="contains" name="T1073,DLL_Side-Loading">Music</ImageLoaded>
			<ImageLoaded condition="contains" name="T1073,DLL_Side-Loading">Video</ImageLoaded>
			<ImageLoaded condition="begin with" name="T1073,DLL_Side-Loading">file:</ImageLoaded>
			<ImageLoaded name="T1073,DLL_Side-Loading" condition="contains">$Recycle.bin\</ImageLoaded>
			<ImageLoaded name="T1073,DLL_Side-Loading" condition="contains">\Windows\IME\</ImageLoaded>
			<Rule groupRelation="and">
				<OriginalFileName condition="is">urlmon.dll</OriginalFileName>
			</Rule>
			<ImageLoaded name="T1047,Windows_Management_Instrumentation" condition="end with">wmiutils.dll</ImageLoaded>
		</ImageLoad>
	</RuleGroup>

	<RuleGroup groupRelation="or">
		<ImageLoad onmatch="exclude">
			<Rule groupRelation="and">
				<Image condition="is">C:\Windows\System32\cscript.exe</Image>
				<OriginalFileName condition="is">scrobj.dll</OriginalFileName>
			</Rule>
			<Rule groupRelation="and">
				<Image name="T1137,Office_Application_Startup" condition="end with">VSTOInstaller.exe</Image>
				<ImageLoaded condition="begin with">C:\Windows\</ImageLoaded>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all"> C:\Users\;\AppData\Local\Microsoft\OneDrive;\FileCoAuth.exe</Image>
				<ImageLoaded condition="contains all">C:\Users\;\AppData\Local\Microsoft\OneDrive\;\FileSyncTelemetryExtensions.dll</ImageLoaded>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all"> C:\Users\;\AppData\Local\Microsoft\OneDrive;\FileCoAuth.exe</Image>
				<ImageLoaded condition="contains all">C:\Users\;\AppData\Local\Microsoft\OneDrive\;\FileCoAuthLib.dll</ImageLoaded>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all"> C:\Users\;\AppData\Local\Microsoft\OneDrive;\FileCoAuth.exe</Image>
				<ImageLoaded condition="contains all">C:\Users\;\AppData\Local\Microsoft\OneDrive\;\OneDriveTelemetryStable.dll</ImageLoaded>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all"> C:\Users\;\AppData\Local\Microsoft\OneDrive;\FileCoAuth.exe</Image>
				<ImageLoaded condition="contains all">C:\Users\;\AppData\Local\Microsoft\OneDrive\;\vcruntime140.dll</ImageLoaded>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all"> C:\Users\;\AppData\Local\Microsoft\OneDrive;\FileCoAuth.exe</Image>
				<ImageLoaded condition="contains all">C:\Users\;\AppData\Local\Microsoft\OneDrive\;\UpdateRingSettings.dll</ImageLoaded>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all"> C:\Users\;\AppData\Local\Microsoft\OneDrive;\FileCoAuth.exe</Image>
				<ImageLoaded condition="contains all">C:\Users\;\AppData\Local\Microsoft\OneDrive\;\LoggingPlatform.dll</ImageLoaded>
			</Rule>
			<Rule groupRelation="and">
				<Image condition="contains all"> C:\Users\;\AppData\Local\Microsoft\OneDrive;\FileCoAuth.exe</Image>
				<ImageLoaded condition="contains all">C:\Users\;\AppData\Local\Microsoft\OneDrive\;\FileCoAuth.exe</ImageLoaded>
			</Rule>
		</ImageLoad>
	</RuleGroup>


	</EventFiltering>
</Sysmon>